<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Find My Wheels</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="title">
      <img id="logo" src="Resources/fmw_logo.png" alt="logotipe" />
    </div>

    <div id="b"><div id="bar"></div></div>

    <div id="Buttons">
      <ul>
        <button id="toggleRTL">Real Time Location</button>
        <button id="HIST">History</button>
      </ul>
    </div>

    <div id="RTL">
      <div id="data">
        <ul id="lat">
          <li id="const"><h2>Latitude</h2></li>
          <li>
            <div id="b"><div id="bar" style="width: 10%"></div></div>
          </li>
          <li><span id="latitude"></span></li>
        </ul>
        <ul id="lon">
          <li id="const"><h2>Longitude</h2></li>
          <li>
            <div id="b"><div id="bar" style="width: 10%"></div></div>
          </li>
          <li><span id="longitude"></span></li>
        </ul>
        <ul id="Tim">
          <li id="const"><h2>Time</h2></li>
          <li>
            <div id="b"><div id="bar" style="width: 10%"></div></div>
          </li>
          <li><span id="time_stamp"></span></li>
        </ul>
        <ul>
          <div id="reset">
            <button onclick="reiniciarYCrearPolilinea()">Restart Track</button>
          </div>
        </ul>
      </div>
    </div>

    <div id="History">
    </div>

    <div id="error">
      <p id="error_message" style="color: red"></p>
      <!-- Elemento para mostrar errores -->
    </div>
    <!-- Agregar un contenedor para el mapa -->
    <div id="cartography">
      <div id="map"></div>
    </div>
    <form id="search-form">
      <label for="start-datetime">Fecha y hora de inicio:</label>
      <input type="datetime-local" id="start-datetime" name="start-datetime" required>
      <label for="end-datetime">Fecha y hora de fin:</label>
      <input type="datetime-local" id="end-datetime" name="end-datetime" required>
      <button type="submit">Buscar</button>
    </form>
  
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="script.js"></script>
    <script>
      // Función para inicializar el mapa
      function initMap() {
        const map = L.map('map').setView([51.505, -0.09], 13);
  
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
  
        const polyline = L.polyline([], { color: 'red' }).addTo(map);
  
        // Escucha los eventos de entrada en los campos de fecha y hora
        document.getElementById('start-datetime').addEventListener('input', function(event) {
          const startDateTime = event.target.value;
          document.getElementById('end-datetime').min = startDateTime;
        });
  
        document.getElementById('end-datetime').addEventListener('input', function(event) {
          const endDateTime = event.target.value;
          document.getElementById('start-datetime').max = endDateTime;
        });
  
        // Escucha el evento de envío del formulario
        document.getElementById('search-form').addEventListener('submit', function(event) {
          event.preventDefault();
          handleFormSubmit(map, polyline);
        });
      }
  
      // Función para manejar el envío del formulario
      function handleFormSubmit(map, polyline) {
        const startDateTime = document.getElementById('start-datetime').value;
        const endDateTime = document.getElementById('end-datetime').value;
  
        // Hacer una solicitud al servidor para obtener las coordenadas
        const url = `extract2.php?start-datetime=${startDateTime}&end-datetime=${endDateTime}`;
  
        fetch(url)
          .then(response => response.json())
          .then(response => {
            if (Array.isArray(response) && response.length > 0) {
              const latlngs = response.map(coord => [parseFloat(coord.latitude), parseFloat(coord.longitude)]);
              polyline.setLatLngs(latlngs);
  
              // Centrar el mapa en las coordenadas de la polilínea
              const bounds = polyline.getBounds();
              map.fitBounds(bounds);
            } else {
              console.error('No se encontraron datos en esa fecha');
            }
          })
          .catch(error => console.error('Error al obtener coordenadas:', error));
      }
  
      // Inicializar el mapa
      initMap();
    </script>
  </body>
</html>
